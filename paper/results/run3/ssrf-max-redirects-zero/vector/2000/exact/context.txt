# pydantic_ai_slim/pydantic_ai/_ssrf.py:50-50
_MAX_REDIRECTS = 0

# tests/test_ssrf.py:9-22
from pydantic_ai._ssrf import (
    _DEFAULT_TIMEOUT,  # pyright: ignore[reportPrivateUsage]
    _MAX_REDIRECTS,  # pyright: ignore[reportPrivateUsage]
    ResolvedUrl,
    build_url_with_ip,
    extract_host_and_port,
    is_cloud_metadata_ip,
    is_private_ip,
    resolve_hostname,
    resolve_redirect_url,
    safe_download,
    validate_and_resolve_url,
    validate_url_protocol,
)

# tests/conftest.py:147-149
    def set(self, name: str, value: str) -> None:
        self.envars[name] = os.getenv(name)
        os.environ[name] = value

# tests/models/test_gemini_vertex.py:6-6
from inline_snapshot import Is, snapshot

# tests/models/test_google.py:16-16
from inline_snapshot import Is, snapshot

# pydantic_ai_slim/pydantic_ai/_ssrf.py:297-368
async def safe_download(
    url: str,
    allow_local: bool = False,
    max_redirects: int = _MAX_REDIRECTS,
    timeout: int = _DEFAULT_TIMEOUT,
) -> httpx.Response:
    """Download content from a URL with SSRF protection.

    This function:
    1. Validates the URL protocol (only http/https allowed)
    2. Resolves the hostname to IP addresses
    3. Validates that no resolved IP is private (unless allow_local=True)
    4. Always blocks cloud metadata endpoints
    5. Makes the request to the resolved IP with the Host header set
    6. Manually follows redirects, validating each hop

    Args:
        url: The URL to download from.
        allow_local: If True, allows requests to private/internal IP addresses.
                    Cloud metadata endpoints are always blocked regardless.
        max_redirects: Maximum number of redirects to follow (default: 10).
        timeout: Request timeout in seconds (default: 30).

    Returns:
        The httpx.Response object.

    Raises:
        ValueError: If the URL fails SSRF validation or too many redirects occur.
        httpx.HTTPStatusError: If the response has an error status code.
    """
    current_url = url
    redirects_followed = 0

    client = cached_async_http_client(timeout=timeout)
    while True:
        # Validate and resolve the current URL
        resolved = await validate_and_resolve_url(current_url, allow_local)

        # Build URL with resolved IP
        request_url = build_url_with_ip(resolved)

        # For HTTPS, set sni_hostname so TLS uses the original hostname for SNI
        # and certificate validation, even though we're connecting to the resolved IP.
        extensions: dict[str, str] = {}
        if resolved.is_https:
            extensions['sni_hostname'] = resolved.hostname

        # Make request with Host header set to original hostname
        response = await client.get(
            request_url,
            headers={'Host': resolved.hostname},
            extensions=extensions,
            follow_redirects=False,
        )

        # Check if we need to follow a redirect
        if response.is_redirect:
            redirects_followed += 1
            if redirects_followed > max_redirects:
                raise ValueError(f'Too many redirects ({redirects_followed}). Maximum allowed: {max_redirects}')

            # Get redirect location
            location = response.headers.get('location')
            if not location:
                raise ValueError('Redirect response missing Location header')

            current_url = resolve_redirect_url(current_url, location)
            continue

        # Not a redirect, we're done
        response.raise_for_status()
        return response

# tests/test_ssrf.py:432-459
    async def test_redirect_followed(self) -> None:
        """Test that redirects are followed with validation."""
        redirect_response = AsyncMock()
        redirect_response.is_redirect = True
        redirect_response.headers = {'location': 'https://cdn.example.com/file.txt'}

        final_response = AsyncMock()
        final_response.is_redirect = False
        final_response.raise_for_status = lambda: None
        final_response.content = b'final content'

        with (
            patch('pydantic_ai._ssrf.run_in_executor') as mock_executor,
            patch('pydantic_ai._ssrf.cached_async_http_client') as mock_client_fn,
        ):
            # First call for example.com, second for cdn.example.com
            mock_executor.side_effect = [
                [(2, 1, 6, '', ('93.184.215.14', 0))],
                [(2, 1, 6, '', ('203.0.113.50', 0))],
            ]

            mock_client = AsyncMock()
            mock_client.get.side_effect = [redirect_response, final_response]
            mock_client_fn.return_value = mock_client

            response = await safe_download('https://example.com/file.txt')
            assert response.content == b'final content'
            assert mock_client.get.call_count == 2

# examples/pydantic_ai_examples/ag_ui/api/agentic_generative_ui.py:6-6
from typing import Any, Literal

# examples/pydantic_ai_examples/chat_app.py:20-20
from typing import Annotated, Any, Literal, TypeVar

# examples/pydantic_ai_examples/slack_lead_qualifier/app.py:1-1
from typing import Any

# examples/pydantic_ai_examples/slack_lead_qualifier/modal.py:1-1
from typing import Any

# examples/pydantic_ai_examples/slack_lead_qualifier/models.py:1-1
from typing import Annotated, Any

# examples/pydantic_ai_examples/slack_lead_qualifier/slack.py:2-2
from typing import Any

# examples/pydantic_ai_examples/sql_gen.py:19-19
from typing import Annotated, Any, TypeAlias

# examples/pydantic_ai_examples/weather_agent.py:16-16
from typing import Any

# pydantic_ai_slim/pydantic_ai/_a2a.py:9-9
from typing import Any, Generic, TypeVar

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:14-14
from typing import TYPE_CHECKING, Any, Generic, Literal, TypeGuard, cast

# pydantic_ai_slim/pydantic_ai/_cli/__init__.py:11-11
from typing import Any

# pydantic_ai_slim/pydantic_ai/_function_schema.py:12-12
from typing import TYPE_CHECKING, Any, Concatenate, cast, get_origin

# pydantic_ai_slim/pydantic_ai/_griffe.py:8-8
from typing import TYPE_CHECKING, Any, Literal, cast

# pydantic_ai_slim/pydantic_ai/_json_schema.py:7-7
from typing import Any, Literal

# pydantic_ai_slim/pydantic_ai/_output.py:9-9
from typing import TYPE_CHECKING, Any, Generic, Literal, cast, overload

# pydantic_ai_slim/pydantic_ai/_parts_manager.py:18-18
from typing import Any, TypeVar

# pydantic_ai_slim/pydantic_ai/_run_context.py:8-8
from typing import TYPE_CHECKING, Any, Generic

# pydantic_ai_slim/pydantic_ai/_system_prompt.py:6-6
from typing import Any, Generic, cast

# pydantic_ai_slim/pydantic_ai/_tool_manager.py:8-8
from typing import Any, Generic, Literal

# pydantic_ai_slim/pydantic_ai/_utils.py:16-26
from typing import (
    TYPE_CHECKING,
    Any,
    Generic,
    TypeAlias,
    TypeGuard,
    TypeVar,
    get_args,
    get_origin,
    overload,
)

# pydantic_ai_slim/pydantic_ai/ag_ui.py:12-12
from typing import Any

# pydantic_ai_slim/pydantic_ai/agent/__init__.py:12-12
from typing import TYPE_CHECKING, Any, ClassVar, overload

# pydantic_ai_slim/pydantic_ai/agent/abstract.py:9-9
from typing import TYPE_CHECKING, Any, Generic, TypeAlias, cast, overload

# pydantic_ai_slim/pydantic_ai/agent/wrapper.py:5-5
from typing import Any, overload

# pydantic_ai_slim/pydantic_ai/builtin_tools.py:6-6
from typing import Annotated, Any, Literal, Union

# pydantic_ai_slim/pydantic_ai/common_tools/duckduckgo.py:6-6
from typing_extensions import Any, TypedDict

# pydantic_ai_slim/pydantic_ai/common_tools/exa.py:11-11
from typing_extensions import Any, TypedDict

# pydantic_ai_slim/pydantic_ai/common_tools/tavily.py:5-5
from typing_extensions import Any, TypedDict

# pydantic_ai_slim/pydantic_ai/durable_exec/dbos/_agent.py:5-5
from typing import Any, Literal, cast, overload

# pydantic_ai_slim/pydantic_ai/durable_exec/dbos/_mcp.py:5-5
from typing import TYPE_CHECKING, Any

# pydantic_ai_slim/pydantic_ai/durable_exec/dbos/_model.py:6-6
from typing import Any

# pydantic_ai_slim/pydantic_ai/durable_exec/prefect/_agent.py:6-6
from typing import Any, overload

# pydantic_ai_slim/pydantic_ai/durable_exec/prefect/_cache_policies.py:2-2
from typing import Any, TypeGuard

# pydantic_ai_slim/pydantic_ai/durable_exec/prefect/_function_toolset.py:3-3
from typing import Any

# pydantic_ai_slim/pydantic_ai/durable_exec/prefect/_mcp_server.py:4-4
from typing import TYPE_CHECKING, Any

# pydantic_ai_slim/pydantic_ai/durable_exec/prefect/_model.py:6-6
from typing import Any

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/__init__.py:6-6
from typing import Any

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_agent.py:8-8
from typing import Any, Literal, overload

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_dynamic_toolset.py:5-5
from typing import Any, Literal

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_function_toolset.py:4-4
from typing import Any, Literal

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_mcp.py:5-5
from typing import Any, Literal

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_model.py:9-9
from typing import Any, cast

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_run_context.py:3-3
from typing import Any

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_toolset.py:6-6
from typing import Annotated, Any, Literal

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_workflow.py:2-2
from typing import Any

# pydantic_ai_slim/pydantic_ai/embeddings/__init__.py:5-5
from typing import Any, ClassVar, Literal, get_args

# pydantic_ai_slim/pydantic_ai/embeddings/bedrock.py:9-9
from typing import TYPE_CHECKING, Any, Literal, cast

# pydantic_ai_slim/pydantic_ai/embeddings/cohere.py:3-3
from typing import Any, Literal, cast

# pydantic_ai_slim/pydantic_ai/embeddings/instrumented.py:8-8
from typing import Any

# pydantic_ai_slim/pydantic_ai/embeddings/result.py:4-4
from typing import Any, Literal

# pydantic_ai_slim/pydantic_ai/embeddings/sentence_transformers.py:6-6
from typing import Any, cast

# pydantic_ai_slim/pydantic_ai/exceptions.py:5-5
from typing import TYPE_CHECKING, Any

# pydantic_ai_slim/pydantic_ai/ext/aci.py:4-4
from typing import Any

# pydantic_ai_slim/pydantic_ai/ext/langchain.py:3-3
from typing import Any, Protocol

# pydantic_ai_slim/pydantic_ai/format_prompt.py:8-8
from typing import Any, Literal

# pydantic_ai_slim/pydantic_ai/mcp.py:14-14
from typing import Annotated, Any, overload

# pydantic_ai_slim/pydantic_ai/messages.py:14-14
from typing import TYPE_CHECKING, Annotated, Any, Literal, TypeAlias, cast, overload

# pydantic_ai_slim/pydantic_ai/models/__init__.py:17-17
from typing import Any, Generic, Literal, TypeVar, get_args, overload

# pydantic_ai_slim/pydantic_ai/models/anthropic.py:8-8
from typing import Any, Literal, cast, overload

# pydantic_ai_slim/pydantic_ai/models/bedrock.py:10-10
from typing import TYPE_CHECKING, Any, Generic, Literal, cast, overload

# pydantic_ai_slim/pydantic_ai/models/cerebras.py:6-6
from typing import Any, Literal, cast

# pydantic_ai_slim/pydantic_ai/models/concurrency.py:8-8
from typing import Any

# pydantic_ai_slim/pydantic_ai/models/fallback.py:7-7
from typing import TYPE_CHECKING, Any

# pydantic_ai_slim/pydantic_ai/models/function.py:10-10
from typing import Any, TypeAlias

# pydantic_ai_slim/pydantic_ai/models/gemini.py:16-16
from typing import Annotated, Any, Literal, Protocol, cast

# pydantic_ai_slim/pydantic_ai/models/google.py:9-9
from typing import Any, Literal, cast, overload

# pydantic_ai_slim/pydantic_ai/models/groq.py:7-7
from typing import Any, Literal, cast, overload

# pydantic_ai_slim/pydantic_ai/models/huggingface.py:7-7
from typing import Any, Literal, cast, overload

# pydantic_ai_slim/pydantic_ai/models/instrumented.py:9-9
from typing import Any, Literal, cast

# pydantic_ai_slim/pydantic_ai/models/mcp_sampling.py:6-6
from typing import TYPE_CHECKING, Any, cast