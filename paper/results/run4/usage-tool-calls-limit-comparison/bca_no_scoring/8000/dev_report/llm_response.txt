```
FILE: pydantic_ai_slim/pydantic_ai/models/test.py
SEARCH:
        if tool_calls and not any(isinstance(m, ModelResponse) for m in messages):
REPLACE:
        if tool_calls and not any(isinstance(m, ModelResponse) for m in messages) and model_request_parameters.tool_calls_limit is not None:
```

```
FILE: pydantic_ai_slim/pydantic_ai/models/test.py
SEARCH:
        if isinstance(output_wrapper, _WrappedTextOutput):
REPLACE:
        if isinstance(output_wrapper, _WrappedTextOutput) and model_request_parameters.tool_calls_limit is not None:
```