FILE: tests/test_asgi.py
SEARCH:
async def read_body(scope, receive, send):
    nonlocal disconnect

    status = 200
    headers = [(b"content-type", "text/plain")]

    await send(
        {"type": "http.response.start", "status": status, "headers": headers}
    )
    more_body = True
    while more_body:
        message = await receive()
        more_body = message.get("more_body", False)

    await send({"type": "http.response.body", "body": b"", "more_body": False})

    # The ASGI spec says of the Disconnect message:
    # "Sent to the application when a HTTP connection is closed or if receive is
    # called after a response has been sent."
    message = await receive()
    disconnect = message.get("type") == "http.disconnect"
REPLACE:
async def read_body(scope, receive, send):
    nonlocal disconnect

    status = 200
    headers = [(b"content-type", "text/plain")]

    await send(
        {"type": "http.response.start", "status": status, "headers": headers}
    )
    more_body = True
    while more_body:
        message = await receive()
        more_body = message.get("more_body", False)

    await send({"type": "http.response.body", "body": b"", "more_body": False})

    # The ASGI spec says of the Disconnect message:
    # "Sent to the application when a HTTP connection is closed or if receive is
    # called after a response has been sent."
    try:
        message = await receive()
        disconnect = message.get("type") == "http.disconnect"
    except Exception:
        disconnect = True
