# pydantic_ai_slim/pydantic_ai/result.py:58-58
    _initial_run_ctx_usage: RunUsage = field(init=False)

# pydantic_ai_slim/pydantic_ai/usage.py:197-197
    output_tokens: int = 0

# tests/test_streaming.py:2286-2304
async def test_custom_output_type_default_str() -> None:
    agent = Agent('test')

    async with agent.run_stream('test') as result:
        response = await result.get_output()
        assert response == snapshot('success (no tool calls)')
    assert result.response == snapshot(
        ModelResponse(
            parts=[TextPart(content='success (no tool calls)')],
            usage=RequestUsage(input_tokens=51, output_tokens=4),
            model_name='test',
            timestamp=IsDatetime(),
            provider_name='test',
        )
    )

    async with agent.run_stream('test', output_type=OutputType) as result:
        response = await result.get_output()
        assert response == snapshot(OutputType(value='a'))

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:23-23
from pydantic_ai.builtin_tools import AbstractBuiltinTool

# tests/test_streaming.py:2307-2316
async def test_custom_output_type_default_structured() -> None:
    agent = Agent('test', output_type=OutputType)

    async with agent.run_stream('test') as result:
        response = await result.get_output()
        assert response == snapshot(OutputType(value='a'))

    async with agent.run_stream('test', output_type=str) as result:
        response = await result.get_output()
        assert response == snapshot('success (no tool calls)')

# tests/test_usage_limits.py:160-202
async def test_multi_agent_usage_no_incr():
    delegate_agent = Agent(TestModel(), output_type=int)

    controller_agent1 = Agent(TestModel())
    run_1_usages: list[RunUsage] = []

    @controller_agent1.tool
    async def delegate_to_other_agent1(ctx: RunContext[None], sentence: str) -> int:
        delegate_result = await delegate_agent.run(sentence)
        delegate_usage = delegate_result.usage()
        run_1_usages.append(delegate_usage)
        assert delegate_usage == snapshot(RunUsage(requests=1, input_tokens=51, output_tokens=4))
        return delegate_result.output

    result1 = await controller_agent1.run('foobar')
    assert result1.output == snapshot('{"delegate_to_other_agent1":0}')
    run_1_usages.append(result1.usage())
    assert result1.usage() == snapshot(RunUsage(requests=2, input_tokens=103, output_tokens=13, tool_calls=1))

    controller_agent2 = Agent(TestModel())

    @controller_agent2.tool
    async def delegate_to_other_agent2(ctx: RunContext[None], sentence: str) -> int:
        delegate_result = await delegate_agent.run(sentence, usage=ctx.usage)
        delegate_usage = delegate_result.usage()
        assert delegate_usage == snapshot(RunUsage(requests=2, input_tokens=102, output_tokens=9))
        return delegate_result.output

    result2 = await controller_agent2.run('foobar')
    assert result2.output == snapshot('{"delegate_to_other_agent2":0}')
    assert result2.usage() == snapshot(RunUsage(requests=3, input_tokens=154, output_tokens=17, tool_calls=1))

    # confirm the usage from result2 is the sum of the usage from result1
    assert result2.usage() == functools.reduce(operator.add, run_1_usages)

    result1_usage = result1.usage()
    result1_usage.details = {'custom1': 10, 'custom2': 20, 'custom3': 0}
    assert result1_usage.opentelemetry_attributes() == {
        'gen_ai.usage.input_tokens': 103,
        'gen_ai.usage.output_tokens': 13,
        'gen_ai.usage.details.custom1': 10,
        'gen_ai.usage.details.custom2': 20,
    }

# pydantic_ai_slim/pydantic_ai/result.py:64-91
    async def stream_output(self, *, debounce_by: float | None = 0.1) -> AsyncIterator[OutputDataT]:
        """Asynchronously stream the (validated) agent outputs."""
        if self._cached_output is not None:
            yield deepcopy(self._cached_output)
            return

        last_response: _messages.ModelResponse | None = None
        async for response in self.stream_responses(debounce_by=debounce_by):
            if self._raw_stream_response.final_result_event is None or (
                last_response and response.parts == last_response.parts
            ):
                continue
            last_response = response

            try:
                yield await self.validate_response_output(response, allow_partial=True)
            except ValidationError:
                pass

        if self._raw_stream_response.final_result_event is not None:  # pragma: no branch
            response = self.response
            # Final validation with allow_partial=False (the default).
            # We always yield the final result even if the content matches the last partial yield, because:
            # 1. Output validators/functions receive partial_output=False only on this final call,
            #    and may behave differently based on that flag
            # 2. Users can rely on the last yielded item being the fully validated output
            self._cached_output = await self.validate_response_output(response)
            yield deepcopy(self._cached_output)

# pydantic_ai_slim/pydantic_ai/result.py:52-52
    _run_ctx: RunContext[AgentDepsT]

# pydantic_ai_slim/pydantic_ai/agent/abstract.py:113-115
    def output_type(self) -> OutputSpec[OutputDataT]:
        """The type of data output by agent runs, used to validate the data returned by the model, defaults to `str`."""
        raise NotImplementedError

# pydantic_ai_slim/pydantic_ai/usage.py:179-179
    tool_calls: int = 0

# pydantic_ai_slim/pydantic_ai/agent/__init__.py:147-147
    _instrument_default: ClassVar[InstrumentationSettings | bool] = False

# tests/models/anthropic/test_output.py:398-416
def test_strict_none_tool_no_output(
    allow_model_requests: None,
    anthropic_model: ANTHROPIC_MODEL_FIXTURE,
) -> None:
    """Tool with strict=None, no output_type â†’ no beta header, tool has no strict field."""
    model = anthropic_model('claude-sonnet-4-5')
    hook = create_header_verification_hook(expect_beta=False, test_name='test_strict_none_tool_no_output')
    model.client._client.event_hooks['request'].append(hook)  # pyright: ignore[reportPrivateUsage]

    agent = Agent(model)

    @agent.tool_plain
    def search_database(query: str) -> str:
        return f'Found 42 results for "{query}"'

    agent.run_sync('Find cities in Europe')

    if errors := hook.errors:  # type: ignore[attr-defined]
        assert False, '\n'.join(sorted(errors))

# tests/models/test_gemini.py:488-493
class AsyncByteStreamList(httpx.AsyncByteStream):
    data: list[bytes]

    async def __aiter__(self) -> AsyncIterator[bytes]:
        for chunk in self.data:
            yield chunk

# pydantic_ai_slim/pydantic_ai/tools.py:497-497
    strict: bool | None = None

# pydantic_ai_slim/pydantic_ai/usage.py:182-182
    input_tokens: int = 0

# examples/pydantic_ai_examples/flight_booking.py:14-21
from pydantic_ai import (
    Agent,
    ModelMessage,
    ModelRetry,
    RunContext,
    RunUsage,
    UsageLimits,
)

# examples/pydantic_ai_examples/flight_booking.py:14-21
from pydantic_ai import (
    Agent,
    ModelMessage,
    ModelRetry,
    RunContext,
    RunUsage,
    UsageLimits,
)

# examples/pydantic_ai_examples/flight_booking.py:14-21
from pydantic_ai import (
    Agent,
    ModelMessage,
    ModelRetry,
    RunContext,
    RunUsage,
    UsageLimits,
)

# examples/pydantic_ai_examples/flight_booking.py:14-21
from pydantic_ai import (
    Agent,
    ModelMessage,
    ModelRetry,
    RunContext,
    RunUsage,
    UsageLimits,
)