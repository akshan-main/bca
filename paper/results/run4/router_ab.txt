
==========================================================================================
Feature Validity Audit
  (Which features can each router legitimately use in a real deployment?)
==========================================================================================

  Router A (pre-retrieval, choose-first):
    VALID:
      entity_count_extracted      — parsed from query text
      entity_count_mapped         — looked up in graph (cheap, local)
      query_identifier_density    — computed from query text
      graph_node_count            — repo-level constant (known at init)
      budget                      — given by user/system

    INVALID (not available before retrieval):
      retrieval_*                 — requires running a retrieval method
      tokens_used, symbols_selected, files_included — assembly output
      assembly_time_ms            — assembly output
      bca_*                       — BCA-specific assembly output

    INVALID (leakage — requires knowing mutation location):
      mutation_symbol_lines       — size of mutated function
      mutation_file_symbols       — symbols in mutated file
      target_file_hit             — requires knowing target file
      target_symbol_hit           — requires knowing target symbol
      min_hops_seed_to_mutation   — requires knowing mutation
      median_hops_seed_to_mutation
      edit_distance_lines         — post-hoc evaluation metric

  Router B (dry-run retrieval, then choose):
    VALID (all Router A features PLUS per-method):
      retrieval_top1_score        — confidence of top retrieval result
      retrieval_budget_utilization — fraction of budget used
      retrieval_softmax_entropy   — score distribution spread
      retrieval_effective_candidates — number of competitive candidates
      retrieval_top1_top2_gap     — gap between #1 and #2 scores
      tokens_used                 — context size produced
      symbols_selected            — number of symbols selected
      files_included              — number of files in context
      bca_frontier_visited        — BCA traversal breadth
      bca_closure_added_*         — BCA closure overhead

      NOTE: These are per-method. Router B has one value per candidate method.

    STILL INVALID (leakage):
      target_file_hit, target_symbol_hit, mutation_*, min_hops_*,
      edit_distance_*, tests_passed, failure_mode, patch, test_output



==========================================================================================
Router A: Choose-First (Pre-Retrieval Features Only)
  Decision based on query + repo features BEFORE running any retrieval.
  Features: entity_count_mapped, query_identifier_density, graph_node_count_log
  Candidates: bca, bca_d1, bca_d5, bca_no_closure, bca_no_scoring, bm25, no_retrieval, repo_map, vector
  Evaluation: LOO-CV, success = predicted method is in passing set
  Two strategies: 'smart' (default→deviate) and 'safest' (always safest)
==========================================================================================

  [DEV_REPORT queries]
    B=2000: n=86 solvable tasks
      Majority vote: vector (60.5%)
      Router A (smart):  65.1%  gap=+11.8%
      Router A (safest): 65.1%  gap=+11.8%
      Random:            35.1%
      Oracle:            100.0%
      Top features (smart):
        query_identifier_density            |coef|=0.888
        entity_count_mapped                 |coef|=0.850
        graph_node_count_log                |coef|=0.514
    B=4000: n=96 solvable tasks
      Majority vote: vector (58.3%)
      Router A (smart):  58.3%  gap=+0.0%
      Router A (safest): 63.5%  gap=+12.5%
      Random:            36.2%
      Oracle:            100.0%
      Top features (smart):
        entity_count_mapped                 |coef|=0.671
        graph_node_count_log                |coef|=0.585
        query_identifier_density            |coef|=0.235
    B=8000: n=106 solvable tasks
      Majority vote: vector (57.5%)
      Router A (smart):  57.5%  gap=+0.0%
      Router A (safest): 60.4%  gap=+6.7%
      Random:            40.0%
      Oracle:            100.0%
      Top features (smart):
        query_identifier_density            |coef|=0.962
        entity_count_mapped                 |coef|=0.941
        graph_node_count_log                |coef|=0.864
    B=10000: n=102 solvable tasks
      Majority vote: bca_d1 (58.8%)
      Router A (smart):  57.8%  gap=-2.4%
      Router A (safest): 58.8%  gap=+0.0%
      Random:            45.4%
      Oracle:            100.0%
      Top features (smart):
        query_identifier_density            |coef|=1.425
        entity_count_mapped                 |coef|=0.897
        graph_node_count_log                |coef|=0.760


==========================================================================================
Router B: Dry-Run Then Choose (Retrieval Confidence Features)
  Runs all retrieval methods locally (no LLM call), examines their
  confidence metrics, picks the best method, then calls LLM once.
  Features: Router A + per-method {top1_score, budget_util, entropy}
  Total features: 27 (3 query + 8 methods x 3 metrics)
  Candidates: bca, bca_d1, bca_d5, bca_no_closure, bca_no_scoring, bm25, repo_map, vector
==========================================================================================

  [DEV_REPORT queries]
    B=2000: n=85 solvable tasks
      Majority vote: vector (61.2%)
      Router B (smart):  68.2%  gap=+18.2%
      Router B (safest): 65.9%  gap=+12.1%
      Random:            39.1%
      Oracle:            100.0%
      Top features (smart, by max |coef|):
        bca_no_scoring_entropy              |coef|=1.015
        graph_node_count_log                |coef|=0.954
        bm25_top1_score                     |coef|=0.767
        bca_d1_budget_util                  |coef|=0.664
        vector_top1_score                   |coef|=0.643
        bca_no_scoring_top1_score           |coef|=0.619
        entity_count_mapped                 |coef|=0.612
    B=4000: n=96 solvable tasks
      Majority vote: vector (58.3%)
      Router B (smart):  61.5%  gap=+7.5%
      Router B (safest): 61.5%  gap=+7.5%
      Random:            40.0%
      Oracle:            100.0%
      Top features (smart, by max |coef|):
        bm25_entropy                        |coef|=0.974
        bca_no_scoring_entropy              |coef|=0.909
        vector_top1_score                   |coef|=0.875
        bca_d1_budget_util                  |coef|=0.863
        bca_no_scoring_top1_score           |coef|=0.842
        graph_node_count_log                |coef|=0.691
        bca_d1_entropy                      |coef|=0.683
    B=8000: n=106 solvable tasks
      Majority vote: vector (57.5%)
      Router B (smart):  56.6%  gap=-2.2%
      Router B (safest): 59.4%  gap=+4.4%
      Random:            44.3%
      Oracle:            100.0%
      Top features (smart, by max |coef|):
        graph_node_count_log                |coef|=0.878
        bca_no_closure_budget_util          |coef|=0.750
        vector_top1_score                   |coef|=0.736
        bca_no_scoring_top1_score           |coef|=0.726
        bca_no_scoring_entropy              |coef|=0.668
        bca_d1_budget_util                  |coef|=0.663
        vector_entropy                      |coef|=0.656
    B=10000: n=102 solvable tasks
      Majority vote: bca_d1 (58.8%)
      Router B (smart):  60.8%  gap=+4.8%
      Router B (safest): 54.9%  gap=-9.5%
      Random:            50.4%
      Oracle:            100.0%
      Top features (smart, by max |coef|):
        bm25_top1_score                     |coef|=1.004
        vector_top1_score                   |coef|=0.819
        vector_entropy                      |coef|=0.801
        bca_d1_budget_util                  |coef|=0.760
        vector_budget_util                  |coef|=0.685
        bm25_entropy                        |coef|=0.653
        bca_no_scoring_top1_score           |coef|=0.652


==========================================================================================
Router Comparison: A vs B vs Majority-Vote vs Random vs Oracle
  Router A candidates: 9 methods (incl. no_retrieval)
  Router B candidates: 8 retrieval methods (excl. no_retrieval)
==========================================================================================

  [DEV_REPORT queries]
  Budget        MajVote     Random    RouterA    RouterB     Oracle      N
  ------------------------------------------------------------------
  B=2000         60.5%      35.1%      65.1%      68.2%     100.0%     86
  B=4000         58.3%      36.2%      58.3%      61.5%     100.0%     96
  B=8000         57.5%      40.0%      57.5%      56.6%     100.0%    106
  B=10000        58.8%      45.4%      57.8%      60.8%     100.0%    102