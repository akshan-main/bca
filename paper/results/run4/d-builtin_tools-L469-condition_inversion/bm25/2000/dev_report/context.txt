# tests/test_builtin_tools.py:78-103
def test_url_context_tool_backward_compatibility():
    """Test that old payloads with 'url_context' kind can be deserialized."""
    adapter = TypeAdapter(AbstractBuiltinTool)

    # Test 1: Old payload with url_context should deserialize to UrlContextTool (which is deprecated)
    old_payload = {'kind': 'url_context', 'max_uses': 5, 'enable_citations': True}
    with pytest.warns(DeprecationWarning, match='Use `WebFetchTool` instead.'):
        result = adapter.validate_python(old_payload)
    assert isinstance(result, UrlContextTool)  # pyright: ignore[reportDeprecated]
    assert isinstance(result, WebFetchTool)  # UrlContextTool is a subclass of WebFetchTool
    assert result.kind == 'url_context'  # Preserves the original kind from payload
    assert result.max_uses == 5
    assert result.enable_citations is True

    # Test 2: Re-serialization should preserve the kind
    serialized = adapter.dump_python(result)
    assert serialized['kind'] == 'url_context'
    assert serialized['max_uses'] == 5
    assert serialized['enable_citations'] is True

    # Test 3: New payload with web_fetch should work normally
    new_payload = {'kind': 'web_fetch', 'max_uses': 10}
    result2 = adapter.validate_python(new_payload)
    assert isinstance(result2, WebFetchTool)
    assert result2.kind == 'web_fetch'
    assert result2.max_uses == 10

# pydantic_ai_slim/pydantic_ai/builtin_tools.py:47-47
    kind: str = 'unknown_builtin_tool'

# pydantic_ai_slim/pydantic_ai/tools.py:512-512
    kind: ToolKind = field(default='function')

# pydantic_ai_slim/pydantic_ai/tools.py:186-186
    kind: Literal['tool-denied'] = 'tool-denied'

# pydantic_ai_slim/pydantic_ai/__init__.py:12-22
from .builtin_tools import (
    CodeExecutionTool,
    FileSearchTool,
    ImageGenerationTool,
    MCPServerTool,
    MemoryTool,
    UrlContextTool,  # pyright: ignore[reportDeprecated]
    WebFetchTool,
    WebSearchTool,
    WebSearchUserLocation,
)

# pydantic_ai_slim/pydantic_ai/messages.py:701-701
    kind: Literal['tool-return'] = 'tool-return'

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_toolset.py:58-58
    kind: Literal['tool_return'] = 'tool_return'

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_toolset.py:46-46
    kind: Literal['call_deferred'] = 'call_deferred'

# pydantic_ai_slim/pydantic_ai/_griffe.py:10-10
from griffe import Docstring, DocstringSectionKind, GoogleOptions, Object as GriffeObject

# pydantic_ai_slim/pydantic_ai/messages.py:901-901
    part_kind: Literal['tool-return'] = 'tool-return'

# pydantic_ai_slim/pydantic_ai/builtin_tools.py:264-264
    kind: str = 'url_context'

# pydantic_ai_slim/pydantic_ai/builtin_tools.py:251-251
    kind: str = 'web_fetch'

# pydantic_ai_slim/pydantic_ai/messages.py:923-923
    part_kind: Literal['builtin-tool-return'] = 'builtin-tool-return'

# pydantic_ai_slim/pydantic_ai/_output.py:675-675
    kind: str

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:33-43
from .tools import (
    BuiltinToolFunc,
    DeferredToolCallResult,
    DeferredToolResult,
    DeferredToolResults,
    RunContext,
    ToolApproved,
    ToolDefinition,
    ToolDenied,
    ToolKind,
)

# pydantic_ai_slim/pydantic_ai/models/instrumented.py:20-20
from opentelemetry.trace import Span, SpanKind, Tracer, TracerProvider, get_tracer_provider

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:33-43
from .tools import (
    BuiltinToolFunc,
    DeferredToolCallResult,
    DeferredToolResult,
    DeferredToolResults,
    RunContext,
    ToolApproved,
    ToolDefinition,
    ToolDenied,
    ToolKind,
)

# pydantic_graph/pydantic_graph/beta/mermaid.py:30-30
NodeKind = Literal['broadcast', 'map', 'join', 'start', 'end', 'step', 'decision']

# pydantic_ai_slim/pydantic_ai/messages.py:266-266
    kind: Literal['video-url'] = 'video-url'

# pydantic_ai_slim/pydantic_ai/messages.py:325-325
    kind: Literal['audio-url'] = 'audio-url'

# pydantic_ai_slim/pydantic_ai/messages.py:372-372
    kind: Literal['image-url'] = 'image-url'

# pydantic_ai_slim/pydantic_ai/builtin_tools.py:369-369
    kind: str = 'memory'

# pydantic_ai_slim/pydantic_ai/messages.py:658-658
    kind: Literal['cache-point'] = 'cache-point'

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_toolset.py:52-52
    kind: Literal['model_retry'] = 'model_retry'

# pydantic_ai_slim/pydantic_ai/messages.py:418-418
    kind: Literal['document-url'] = 'document-url'

# pydantic_graph/pydantic_graph/beta/mermaid.py:38-38
    kind: NodeKind

# pydantic_graph/pydantic_graph/persistence/__init__.py:79-79
    kind: Literal['end'] = 'end'

# pydantic_ai_slim/pydantic_ai/messages.py:1043-1043
    kind: Literal['request'] = 'request'

# pydantic_ai_slim/pydantic_ai/tools.py:174-174
    kind: Literal['tool-approved'] = 'tool-approved'

# pydantic_graph/pydantic_graph/persistence/__init__.py:58-58
    kind: Literal['node'] = 'node'

# pydantic_ai_slim/pydantic_ai/messages.py:759-759
    part_kind: Literal['user-prompt'] = 'user-prompt'

# pydantic_ai_slim/pydantic_ai/builtin_tools.py:152-152
    kind: str = 'web_search'

# pydantic_ai_slim/pydantic_ai/builtin_tools.py:433-433
    kind: str = 'mcp_server'

# pydantic_ai_slim/pydantic_ai/messages.py:493-493
    kind: Literal['binary'] = 'binary'

# pydantic_ai_slim/pydantic_ai/messages.py:1318-1318
    kind: Literal['response'] = 'response'

# pydantic_ai_slim/pydantic_ai/builtin_tools.py:464-464
    kind: str = 'file_search'

# pydantic_ai_slim/pydantic_ai/messages.py:1963-1963
    event_kind: Literal['final_result'] = 'final_result'

# pydantic_ai_slim/pydantic_ai/builtin_tools.py:191-191
    kind: str = 'code_execution'

# pydantic_ai_slim/pydantic_ai/durable_exec/temporal/_toolset.py:40-40
    kind: Literal['approval_required'] = 'approval_required'

# pydantic_ai_slim/pydantic_ai/messages.py:1088-1088
    part_kind: Literal['text'] = 'text'

# pydantic_ai_slim/pydantic_ai/messages.py:1178-1178
    part_kind: Literal['file'] = 'file'

# pydantic_ai_slim/pydantic_ai/run.py:452-452
    event_kind: Literal['agent_run_result'] = 'agent_run_result'

# pydantic_ai_slim/pydantic_ai/builtin_tools.py:356-356
    kind: str = 'image_generation'

# pydantic_ai_slim/pydantic_ai/messages.py:2052-2052
    event_kind: Literal['builtin_tool_result'] = 'builtin_tool_result'

# pydantic_ai_slim/pydantic_ai/messages.py:1140-1140
    part_kind: Literal['thinking'] = 'thinking'

# pydantic_ai_slim/pydantic_ai/messages.py:1272-1272
    part_kind: Literal['tool-call'] = 'tool-call'

# pydantic_ai_slim/pydantic_ai/messages.py:2013-2013
    event_kind: Literal['function_tool_result'] = 'function_tool_result'

# pydantic_ai_slim/pydantic_ai/messages.py:1949-1949
    event_kind: Literal['part_end'] = 'part_end'

# pydantic_ai_slim/pydantic_ai/messages.py:967-967
    part_kind: Literal['retry-prompt'] = 'retry-prompt'

# pydantic_ai_slim/pydantic_ai/messages.py:148-148
    part_kind: Literal['system-prompt'] = 'system-prompt'

# pydantic_ai_slim/pydantic_ai/messages.py:1909-1909
    event_kind: Literal['part_start'] = 'part_start'

# pydantic_ai_slim/pydantic_ai/messages.py:1925-1925
    event_kind: Literal['part_delta'] = 'part_delta'

# pydantic_ai_slim/pydantic_ai/messages.py:1282-1282
    part_kind: Literal['builtin-tool-call'] = 'builtin-tool-call'

# pydantic_ai_slim/pydantic_ai/messages.py:1941-1943
    next_part_kind: (
        Literal['text', 'thinking', 'tool-call', 'builtin-tool-call', 'builtin-tool-return', 'file'] | None
    ) = None

# pydantic_ai_slim/pydantic_ai/messages.py:2036-2036
    event_kind: Literal['builtin_tool_call'] = 'builtin_tool_call'

# tests/test_mcp.py:1166-1247
async def test_tool_returning_unstructured_dict(allow_model_requests: None, agent: Agent):
    async with agent:
        result = await agent.run('Get me an unstructured dict, respond on one line')
        assert result.output == snapshot('{"foo":"bar","baz":123}')
        assert result.all_messages() == snapshot(
            [
                ModelRequest(
                    parts=[
                        UserPromptPart(
                            content='Get me an unstructured dict, respond on one line',
                            timestamp=IsDatetime(),
                        )
                    ],
                    timestamp=IsDatetime(),
                    run_id=IsStr(),
                ),
                ModelResponse(
                    parts=[
                        ToolCallPart(
                            tool_name='get_unstructured_dict', args='{}', tool_call_id='call_R0n2R7S9vL2aZOX25T9jahTd'
                        )
                    ],
                    usage=RequestUsage(
                        input_tokens=343,
                        output_tokens=12,
                        details={
                            'accepted_prediction_tokens': 0,
                            'audio_tokens': 0,
                            'reasoning_tokens': 0,
                            'rejected_prediction_tokens': 0,
                        },
                    ),
                    model_name='gpt-4o-2024-08-06',
                    timestamp=IsDatetime(),
                    provider_name='openai',
                    provider_url='https://api.openai.com/v1/',
                    provider_details={
                        'finish_reason': 'tool_calls',
                        'timestamp': IsDatetime(),
                    },
                    provider_response_id='chatcmpl-CLbP82ODQMEznhobUKdq6Rjn9Aa12',
                    finish_reason='tool_call',
                    run_id=IsStr(),
                ),
                ModelRequest(
                    parts=[
                        ToolReturnPart(
                            tool_name='get_unstructured_dict',
                            content={'foo': 'bar', 'baz': 123},
                            tool_call_id='call_R0n2R7S9vL2aZOX25T9jahTd',
                            timestamp=IsDatetime(),
                        )
                    ],
                    timestamp=IsDatetime(),
                    run_id=IsStr(),
                ),
                ModelResponse(
                    parts=[TextPart(content='{"foo":"bar","baz":123}')],
                    usage=RequestUsage(
                        input_tokens=374,
                        output_tokens=10,
                        details={
                            'accepted_prediction_tokens': 0,
                            'audio_tokens': 0,
                            'reasoning_tokens': 0,
                            'rejected_prediction_tokens': 0,
                        },
                    ),
                    model_name='gpt-4o-2024-08-06',
                    timestamp=IsDatetime(),
                    provider_name='openai',
                    provider_url='https://api.openai.com/v1/',
                    provider_details={
                        'finish_reason': 'stop',
                        'timestamp': IsDatetime(),
                    },
                    provider_response_id='chatcmpl-CLbPAOYN3jPYdvYeD8JNOOXF5N554',
                    finish_reason='stop',
                    run_id=IsStr(),
                ),
            ]
        )

# pydantic_ai_slim/pydantic_ai/messages.py:1984-1984
    event_kind: Literal['function_tool_call'] = 'function_tool_call'

# pydantic_ai_slim/pydantic_ai/messages.py:1581-1581
    part_delta_kind: Literal['text'] = 'text'

# tests/test_builtin_tools.py:72-75
def test_url_context_tool_is_deprecated():
    """Test that UrlContextTool is deprecated and warns users to use WebFetchTool instead."""
    with pytest.warns(DeprecationWarning, match='Use `WebFetchTool` instead.'):
        UrlContextTool()  # pyright: ignore[reportDeprecated]

# pydantic_ai_slim/pydantic_ai/messages.py:1638-1638
    part_delta_kind: Literal['thinking'] = 'thinking'

# pydantic_ai_slim/pydantic_ai/messages.py:1751-1751
    part_delta_kind: Literal['tool_call'] = 'tool_call'

# pydantic_ai_slim/pydantic_ai/messages.py:1901-1903
    previous_part_kind: (
        Literal['text', 'thinking', 'tool-call', 'builtin-tool-call', 'builtin-tool-return', 'file'] | None
    ) = None

# pydantic_ai_slim/pydantic_ai/tools.py:491-491
    outer_typed_dict_key: str | None = None

# tests/mcp_server.py:151-152
async def get_unstructured_dict() -> dict[str, Any]:
    return {'foo': 'bar', 'baz': 123}

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:8-8
from collections import defaultdict, deque

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:8-8
from collections import defaultdict, deque

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:8-8
from collections import defaultdict, deque

# pydantic_ai_slim/pydantic_ai/_agent_graph.py:8-8
from collections import defaultdict, deque