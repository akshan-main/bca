# Codebase Context for: GraphBuilder accumulates stale nodes and edges when build_from_directory is called multiple times — the second build has duplicate symbols from the first.
# 19 symbols from 11 files (~1,007 tokens, 101% of budget)

## paper/experiments/benchmark.py
# Included because: graph expansion (depth 2)

# [function] _restore_mutation (relevance: 0.40, depth: 2)
 831 | def _restore_mutation(repo_path: Path, mutation: dict, original: str) -> None:
 832 |     """Restore original content after mutation."""
 833 |     file_path = repo_path / mutation["file"]
 834 |     file_path.write_text(original)

## src/cegraph/context/_native.py
# Included because: graph expansion (depth 2)

# [method] NativeGraph.add_edge (relevance: 0.63, depth: 2)
 229 |     def add_edge(self, src: int, dst: int, weight: float) -> None:
 230 |         self._lib.cag_graph_add_edge(self._handle, src, dst, weight)

## src/cegraph/context/models.py
# Included because: graph expansion (depth 3)

# [method] TokenEstimator.estimate (relevance: 0.50, depth: 3)
 166 |     def estimate(cls, text: str) -> int:
 167 |         """Estimate token count for a string."""
 168 |         return max(1, int(len(text) / cls.CHARS_PER_TOKEN))

# [method] TokenEstimator.estimate_lines (relevance: 0.42, depth: 3)
 171 |     def estimate_lines(cls, line_count: int, avg_line_length: int = 40) -> int:
 172 |         """Estimate tokens for a given number of lines."""
 173 |         return max(1, int(line_count * avg_line_length / cls.CHARS_PER_TOKEN))

## src/cegraph/graph/builder.py
# Included because: matches 'build_from_directory'; graph expansion (depth 1)

# [method] GraphBuilder.__init__ (relevance: 0.78, depth: 1)
  25 |     def __init__(self) -> None:
  26 |         self.graph = nx.DiGraph()
  27 |         self._file_hashes: dict[str, str] = {}
  28 |         self._unresolved: list[Relationship] = []

# [method] GraphBuilder.build_from_directory (relevance: 1.24, depth: 0)
  30 |     def build_from_directory(
  31 |         self,
  32 |         root: str | Path,
  33 |         config: ProjectConfig | None = None,
  34 |         progress_callback: callable | None = None,
  35 |     ) -> nx.DiGraph:
  36 |         """Build the full knowledge graph from a directory.
  37 | 
  38 |         Args:
  39 |             root: Root directory to index.
  40 |             config: Project configuration.
  41 |             progress_callback: Optional callback(file_path, current, total).
  42 | 
  43 |         Returns:
  44 |             The constructed NetworkX directed graph.
  45 |         """
  46 |         root = Path(root).resolve()
  47 |         indexer_config = config.indexer if config else IndexerConfig()
  48 | 
  49 |         # Reset state so reusing a builder doesn't accumulate stale data
  50 |         # self.graph = nx.DiGraph()
  51 |         # self._file_hashes = {}
  52 |         # self._unresolved = []
  53 | 
  54 |         # Parse all files
  55 |         all_parsed = parse_directory(root, indexer_config, progress_callback)
  56 | 
  57 |         # Build graph from parsed results
  58 |         for file_symbols in all_parsed:
  59 |             self._add_file(file_symbols, root)
  60 | 
  61 |         # Resolve cross-file references
  62 |         self._resolve_references()
  63 | 
  64 |         return self.graph

## src/cegraph/graph/store.py
# Included because: graph expansion (depth 2)

# [method] GraphStore.close (relevance: 0.63, depth: 2)
 499 |     def close(self) -> None:
 500 |         """Close the database connection."""
 501 |         if self._conn:
 502 |             self._conn.close()
 503 |             self._conn = None

## src/cegraph/tools/registry.py
# Included because: graph expansion (depth 2); graph expansion (depth 3)

# [method] ToolRegistry.get (relevance: 0.73, depth: 2)
  26 |     def get(self, name: str) -> Callable | None:
  27 |         """Get a tool function by name."""
  28 |         return self._tools.get(name)

# [method] ToolRegistry.get_definition (relevance: 0.29, depth: 3)
  30 |     def get_definition(self, name: str) -> ToolDefinition | None:
  31 |         """Get a tool definition by name."""
  32 |         return self._definitions.get(name)

# [method] ToolRegistry.list_tools (relevance: 0.35, depth: 2)
  34 |     def list_tools(self) -> list[str]:
  35 |         """List all registered tool names."""
  36 |         return list(self._tools.keys())

## src/cegraph/ui/console.py
# Included because: graph expansion (depth 2); graph expansion (depth 3)

# [method] Console.success (relevance: 0.45, depth: 2)
  33 |     def success(self, message: str) -> None:
  34 |         self.console.print(f"[green]✓[/green] {message}")

# [method] Console.error (relevance: 0.46, depth: 3)
  36 |     def error(self, message: str) -> None:
  37 |         self.console.print(f"[red]✗[/red] {message}")

# [method] Console.warning (relevance: 0.42, depth: 3)
  39 |     def warning(self, message: str) -> None:
  40 |         self.console.print(f"[yellow]![/yellow] {message}")

# [method] Console.info (relevance: 0.55, depth: 2)
  42 |     def info(self, message: str) -> None:
  43 |         self.console.print(f"[blue]i[/blue] {message}")

## tests/test_graph.py
# Included because: graph expansion (depth 1)

# [method] TestGraphBuilder.test_build_from_directory (relevance: 0.58, depth: 1)
  16 |     def test_build_from_directory(self, tmp_project: Path):
  17 |         builder = GraphBuilder()
  18 |         graph = builder.build_from_directory(tmp_project)
  19 | 
  20 |         assert graph.number_of_nodes() > 0
  21 |         assert graph.number_of_edges() > 0

# [method] TestGraphQuery._build_query (relevance: 0.80, depth: 1)
 155 |     def _build_query(self, tmp_project: Path) -> GraphQuery:
 156 |         builder = GraphBuilder()
 157 |         graph = builder.build_from_directory(tmp_project)
 158 |         return GraphQuery(graph)

## tests/test_impact_bot.py
# Included because: matches 'multiple'

# [method] TestDiffParser.test_parse_multiple_files (relevance: 0.39, depth: 0)
  95 |     def test_parse_multiple_files(self):
  96 |         combined = SAMPLE_DIFF + SAMPLE_DIFF_NEW_FILE
  97 |         diffs = parse_diff(combined)
  98 |         assert len(diffs) == 2

## tests/test_search.py
# Included because: graph expansion (depth 1)

# [method] TestLexicalSearch._build_search (relevance: 0.65, depth: 1)
  15 |     def _build_search(self, tmp_project: Path) -> LexicalSearch:
  16 |         builder = GraphBuilder()
  17 |         graph = builder.build_from_directory(tmp_project)
  18 |         return LexicalSearch(tmp_project, graph)

## tests/test_tools.py
# Included because: graph expansion (depth 1)

# [method] TestCeGraphTools._build_tools (relevance: 0.69, depth: 1)
  16 |     def _build_tools(self, tmp_project: Path) -> CeGraphTools:
  17 |         builder = GraphBuilder()
  18 |         graph = builder.build_from_directory(tmp_project)
  19 |         query = GraphQuery(graph)
  20 |         search = HybridSearch(tmp_project, graph)
  21 |         return CeGraphTools(tmp_project, graph, query, search)
